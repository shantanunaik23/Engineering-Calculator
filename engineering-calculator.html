<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shan's Engineering Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 1.5rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
            border-left: 4px solid #2563eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-content h1 {
            color: #1e293b;
            margin-bottom: 0.25rem;
            font-size: 1.75rem;
            font-weight: 600;
        }

        .subtitle {
            color: #64748b;
            font-size: 0.9rem;
        }

        .ai-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .ai-badge {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ai-badge.offline {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #cbd5e1;
        }

        .ai-badge.online {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .ai-login-btn {
            padding: 0.5rem 1rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .ai-login-btn:hover {
            background: #1d4ed8;
        }

        .ai-login-btn.logout {
            background: #64748b;
        }

        .ai-login-btn.logout:hover {
            background: #475569;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .ai-provider-select {
            margin-bottom: 1.5rem;
        }

        .provider-option {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .provider-option:hover {
            border-color: #2563eb;
            background: #f8fafc;
        }

        .provider-option.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .provider-option h4 {
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .provider-option p {
            color: #64748b;
            font-size: 0.875rem;
        }

        .api-key-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95rem;
            margin-top: 1rem;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .modal-footer {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .modal-btn.primary {
            background: #2563eb;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #1d4ed8;
        }

        .modal-btn.secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .modal-btn.secondary:hover {
            background: #e2e8f0;
        }

        .info-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .info-box h5 {
            color: #1e40af;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .info-box p {
            color: #1e40af;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .info-box a {
            color: #2563eb;
            text-decoration: none;
            font-weight: 500;
        }

        .info-box a:hover {
            text-decoration: underline;
        }

        .search-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        input[type="text"] {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #2563eb;
        }

        button {
            padding: 0.75rem 1.5rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover:not(:disabled) {
            background: #1d4ed8;
        }

        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .example-queries {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .example-tag {
            padding: 0.5rem 0.875rem;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #475569;
        }

        .example-tag:hover {
            background: #e2e8f0;
            border-color: #2563eb;
            color: #2563eb;
        }

        .advanced-options {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .advanced-toggle {
            cursor: pointer;
            color: #2563eb;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            user-select: none;
        }

        .advanced-toggle:hover {
            color: #1d4ed8;
        }

        .advanced-content {
            margin-top: 1rem;
            display: none;
        }

        .advanced-content.visible {
            display: block;
        }

        .option-group {
            margin-bottom: 1rem;
        }

        .option-label {
            display: block;
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .standard-info {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }

        .standard-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .standard-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 1.1rem;
            flex: 1;
        }

        .copy-btns {
            display: flex;
            gap: 0.5rem;
        }

        .copy-btn {
            padding: 0.4rem 0.75rem;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .copy-btn:hover {
            background: #f1f5f9;
            border-color: #2563eb;
            color: #2563eb;
        }

        .standard-description {
            color: #475569;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .formula-box {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            font-family: 'Courier New', monospace;
            margin-top: 1rem;
            overflow-x: auto;
            font-size: 1rem;
        }

        .variables-list {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .variable-item {
            color: #475569;
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }

        .calculator-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e2e8f0;
        }

        .calc-header {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1.25rem;
        }

        .input-field {
            margin-bottom: 1.25rem;
        }

        .input-label {
            display: block;
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .input-with-unit {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .input-with-unit input {
            flex: 1;
        }

        .unit-label {
            color: #64748b;
            font-weight: 500;
            min-width: 60px;
            font-size: 0.9rem;
        }

        input[type="number"] {
            width: 100%;
            padding: 0.65rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #2563eb;
        }

        .result-box {
            background: #2563eb;
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .result-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .result-value {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .result-unit {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .ai-features-locked {
            background: #fef3c7;
            border: 1px solid #fde68a;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .ai-features-locked p {
            flex: 1;
            color: #92400e;
            font-size: 0.9rem;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #1e293b;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 0.75rem;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.show {
            display: flex;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            background: #10b981;
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            min-width: 180px;
            padding: 0.65rem 1.25rem;
            font-size: 0.9rem;
        }

        .action-btn.locked {
            background: #cbd5e1;
            cursor: not-allowed;
            position: relative;
        }

        .derivation-btn {
            background: #059669;
            margin-top: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.65rem 1.25rem;
            font-size: 0.9rem;
        }

        .derivation-btn:hover:not(:disabled) {
            background: #047857;
        }

        .derivation-btn.locked {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            border-left: 4px solid #dc2626;
        }

        .metadata-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            font-size: 0.875rem;
            color: #64748b;
        }

        .metadata-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .metadata-row:last-child {
            border-bottom: none;
        }

        .metadata-label {
            font-weight: 500;
            color: #475569;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .header, .search-section, .action-buttons, .toast, .modal {
                display: none !important;
            }
            .container {
                max-width: 100%;
            }
            .results-section {
                box-shadow: none;
            }
            button {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>‚öôÔ∏è Shan's Engineering Calculator</h1>
                <p class="subtitle">Professional engineering calculations with standards compliance</p>
            </div>
            <div class="ai-status">
                <div class="ai-badge offline" id="aiBadge">
                    <span>ü§ñ</span>
                    <span id="aiStatusText">AI Features: Offline</span>
                </div>
                <button class="ai-login-btn" id="aiLoginBtn" onclick="showAIModal()">
                    Connect AI
                </button>
            </div>
        </div>

        <div id="toast" class="toast">
            <span id="toastMessage"></span>
        </div>

        <!-- AI Login Modal -->
        <div id="aiModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">Connect AI Provider</div>
                <div class="modal-body">
                    <div class="info-box">
                        <h5>üîí Your API Key is Secure</h5>
                        <p>Your API key is stored only in your browser and never sent to our servers. It's used directly to communicate with your chosen AI provider.</p>
                    </div>

                    <div class="ai-provider-select">
                        <label class="option-label">Choose AI Provider:</label>
                        
                        <div class="provider-option" data-provider="anthropic" onclick="selectProvider('anthropic')">
                            <h4>üî∑ Anthropic Claude</h4>
                            <p>Most capable for engineering calculations. Get API key at <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a></p>
                        </div>

                        <div class="provider-option" data-provider="openai" onclick="selectProvider('openai')">
                            <h4>üü¢ OpenAI GPT</h4>
                            <p>Versatile and widely used. Get API key at <a href="https://platform.openai.com/" target="_blank">platform.openai.com</a></p>
                        </div>

                        <div class="provider-option" data-provider="groq" onclick="selectProvider('groq')">
                            <h4>‚ö° Groq</h4>
                            <p>Ultra-fast inference with generous free tier. Get API key at <a href="https://console.groq.com/" target="_blank">console.groq.com</a></p>
                        </div>
                    </div>

                    <input 
                        type="password" 
                        id="apiKeyInput" 
                        class="api-key-input" 
                        placeholder="Paste your API key here"
                    >
                </div>
                <div class="modal-footer">
                    <button class="modal-btn secondary" onclick="closeAIModal()">Cancel</button>
                    <button class="modal-btn primary" onclick="connectAI()">Connect</button>
                </div>
            </div>
        </div>

        <div class="search-section">
            <div class="input-group">
                <input 
                    type="text" 
                    id="queryInput" 
                    placeholder="e.g., calculate flow rate through a 40NB pipe"
                    autocomplete="off"
                >
                <button id="searchBtn" onclick="searchFormula()">Find Formula</button>
            </div>
            
            <div class="example-queries">
                <div class="example-tag" onclick="useExample('calculate flow rate through a 40NB pipe')">
                    Flow rate in pipe
                </div>
                <div class="example-tag" onclick="useExample('calculate Reynolds number')">
                    Reynolds number
                </div>
                <div class="example-tag" onclick="useExample('calculate pressure drop in pipe')">
                    Pressure drop
                </div>
                <div class="example-tag" onclick="useExample('calculate heat transfer through a wall')">
                    Heat transfer
                </div>
                <div class="example-tag" onclick="useExample('calculate beam deflection')">
                    Beam deflection
                </div>
            </div>

            <div class="advanced-options">
                <div class="advanced-toggle" onclick="toggleAdvanced()">
                    <span id="advancedToggleIcon">‚ñ∂</span>
                    <span>Advanced Options</span>
                </div>
                <div id="advancedContent" class="advanced-content">
                    <div class="option-group">
                        <label class="option-label">Preferred Standard (Optional)</label>
                        <select id="preferredStandard">
                            <option value="">Auto-detect best standard</option>
                            <option value="BS EN">BS EN (British/European)</option>
                            <option value="ASME">ASME (American Society of Mechanical Engineers)</option>
                            <option value="ISO">ISO (International Organization for Standardization)</option>
                            <option value="API">API (American Petroleum Institute)</option>
                            <option value="ASTM">ASTM (American Society for Testing and Materials)</option>
                            <option value="DIN">DIN (German Institute for Standardization)</option>
                            <option value="IEEE">IEEE (Institute of Electrical and Electronics Engineers)</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Specific Formula (Optional)</label>
                        <input 
                            type="text" 
                            id="specificFormula" 
                            placeholder="e.g., Darcy-Weisbach equation, Hazen-Williams formula"
                        >
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingSection" class="search-section loading" style="display: none;">
            <div class="spinner"></div>
            <p>Searching engineering formulas...</p>
        </div>

        <div id="resultsSection" class="results-section">
            <!-- Results will be populated here -->
        </div>
    </div>

    <script>
        // Formula Database (Built-in formulas - no AI needed)
        const FORMULA_DATABASE = {
            "flow rate pipe": {
                standard: "ISO 5167-1",
                standardName: "Measurement of fluid flow by means of pressure differential devices",
                description: "Calculates volumetric flow rate through a pipe using the continuity equation. Applies to incompressible, steady flow in circular pipes.",
                formula: "Q = A √ó v",
                formulaDescription: "Flow rate equals cross-sectional area multiplied by velocity",
                variables: [
                    { symbol: "A", name: "Cross-sectional Area", description: "Internal cross-sectional area of pipe", unit: "m¬≤", defaultValue: null },
                    { symbol: "v", name: "Flow Velocity", description: "Average velocity of fluid", unit: "m/s", defaultValue: null }
                ],
                resultVariable: { symbol: "Q", name: "Flow Rate", unit: "m¬≥/s" }
            },
            "reynolds number": {
                standard: "BS EN 12560",
                standardName: "Flanges and their joints - Dimensions of gaskets for PN-designated flanges",
                description: "Calculates Reynolds number to determine flow regime (laminar, transitional, or turbulent) in a pipe.",
                formula: "Re = (œÅ √ó v √ó D) / Œº",
                formulaDescription: "Reynolds number is the ratio of inertial forces to viscous forces",
                variables: [
                    { symbol: "œÅ", name: "Fluid Density", description: "Density of the fluid", unit: "kg/m¬≥", defaultValue: null },
                    { symbol: "v", name: "Flow Velocity", description: "Average velocity of fluid", unit: "m/s", defaultValue: null },
                    { symbol: "D", name: "Pipe Diameter", description: "Internal diameter of pipe", unit: "m", defaultValue: null },
                    { symbol: "Œº", name: "Dynamic Viscosity", description: "Dynamic viscosity of fluid", unit: "Pa¬∑s", defaultValue: null }
                ],
                resultVariable: { symbol: "Re", name: "Reynolds Number", unit: "dimensionless" }
            },
            "pressure drop pipe": {
                standard: "ASME B31.3",
                standardName: "Process Piping",
                description: "Calculates pressure drop due to friction in pipe flow using the Darcy-Weisbach equation.",
                formula: "ŒîP = f √ó (L/D) √ó (œÅ √ó v¬≤/2)",
                formulaDescription: "Pressure drop is proportional to friction factor, pipe length, and velocity squared",
                variables: [
                    { symbol: "f", name: "Friction Factor", description: "Darcy friction factor (dimensionless)", unit: "dimensionless", defaultValue: null },
                    { symbol: "L", name: "Pipe Length", description: "Length of pipe section", unit: "m", defaultValue: null },
                    { symbol: "D", name: "Pipe Diameter", description: "Internal diameter of pipe", unit: "m", defaultValue: null },
                    { symbol: "œÅ", name: "Fluid Density", description: "Density of the fluid", unit: "kg/m¬≥", defaultValue: null },
                    { symbol: "v", name: "Flow Velocity", description: "Average velocity of fluid", unit: "m/s", defaultValue: null }
                ],
                resultVariable: { symbol: "ŒîP", name: "Pressure Drop", unit: "Pa" }
            },
            "heat transfer wall": {
                standard: "ISO 6946",
                standardName: "Building components and building elements - Thermal resistance and thermal transmittance",
                description: "Calculates heat transfer through a wall using Fourier's law of heat conduction.",
                formula: "Q = (k √ó A √ó ŒîT) / L",
                formulaDescription: "Heat transfer rate is proportional to thermal conductivity, area, and temperature difference",
                variables: [
                    { symbol: "k", name: "Thermal Conductivity", description: "Thermal conductivity of wall material", unit: "W/(m¬∑K)", defaultValue: null },
                    { symbol: "A", name: "Wall Area", description: "Surface area of wall", unit: "m¬≤", defaultValue: null },
                    { symbol: "ŒîT", name: "Temperature Difference", description: "Temperature difference across wall", unit: "K", defaultValue: null },
                    { symbol: "L", name: "Wall Thickness", description: "Thickness of wall", unit: "m", defaultValue: null }
                ],
                resultVariable: { symbol: "Q", name: "Heat Transfer Rate", unit: "W" }
            },
            "beam deflection": {
                standard: "AISC 360",
                standardName: "Specification for Structural Steel Buildings",
                description: "Calculates maximum deflection of a simply supported beam with uniformly distributed load.",
                formula: "Œ¥ = (5 √ó w √ó L‚Å¥) / (384 √ó E √ó I)",
                formulaDescription: "Deflection depends on load, beam length, modulus of elasticity, and moment of inertia",
                variables: [
                    { symbol: "w", name: "Distributed Load", description: "Uniformly distributed load per unit length", unit: "N/m", defaultValue: null },
                    { symbol: "L", name: "Beam Length", description: "Span length of beam", unit: "m", defaultValue: null },
                    { symbol: "E", name: "Modulus of Elasticity", description: "Young's modulus of beam material", unit: "Pa", defaultValue: null },
                    { symbol: "I", name: "Moment of Inertia", description: "Second moment of area", unit: "m‚Å¥", defaultValue: null }
                ],
                resultVariable: { symbol: "Œ¥", name: "Maximum Deflection", unit: "m" }
            }
        };

        // AI Configuration
        let aiConfig = {
            connected: false,
            provider: null,
            apiKey: null
        };

        let currentCalculation = null;

        // Load saved AI config
        function loadAIConfig() {
            const saved = localStorage.getItem('aiConfig');
            if (saved) {
                aiConfig = JSON.parse(saved);
                updateAIStatus();
            }
        }

        // Save AI config
        function saveAIConfig() {
            localStorage.setItem('aiConfig', JSON.stringify(aiConfig));
        }

        // Update AI status badge
        function updateAIStatus() {
            const badge = document.getElementById('aiBadge');
            const statusText = document.getElementById('aiStatusText');
            const loginBtn = document.getElementById('aiLoginBtn');

            if (aiConfig.connected) {
                badge.className = 'ai-badge online';
                statusText.textContent = `AI: ${aiConfig.provider.toUpperCase()}`;
                loginBtn.textContent = 'Disconnect AI';
                loginBtn.className = 'ai-login-btn logout';
                loginBtn.onclick = disconnectAI;
            } else {
                badge.className = 'ai-badge offline';
                statusText.textContent = 'AI Features: Offline';
                loginBtn.textContent = 'Connect AI';
                loginBtn.className = 'ai-login-btn';
                loginBtn.onclick = showAIModal;
            }
        }

        // Modal functions
        function showAIModal() {
            document.getElementById('aiModal').classList.add('show');
        }

        function closeAIModal() {
            document.getElementById('aiModal').classList.remove('show');
            document.getElementById('apiKeyInput').value = '';
            document.querySelectorAll('.provider-option').forEach(el => {
                el.classList.remove('selected');
            });
        }

        function selectProvider(provider) {
            document.querySelectorAll('.provider-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-provider="${provider}"]`).classList.add('selected');
        }

        function connectAI() {
            const selectedProvider = document.querySelector('.provider-option.selected');
            const apiKey = document.getElementById('apiKeyInput').value.trim();

            if (!selectedProvider) {
                showToast('Please select an AI provider', false);
                return;
            }

            if (!apiKey) {
                showToast('Please enter your API key', false);
                return;
            }

            aiConfig.connected = true;
            aiConfig.provider = selectedProvider.dataset.provider;
            aiConfig.apiKey = apiKey;

            saveAIConfig();
            updateAIStatus();
            closeAIModal();
            showToast(`Connected to ${aiConfig.provider.toUpperCase()} successfully!`);
        }

        function disconnectAI() {
            aiConfig = { connected: false, provider: null, apiKey: null };
            saveAIConfig();
            updateAIStatus();
            showToast('AI disconnected');
        }

        // Search in database first, then optionally use AI
        function searchFormula() {
            const query = document.getElementById('queryInput').value.trim().toLowerCase();
            if (!query) return;

            const loadingSection = document.getElementById('loadingSection');
            const resultsSection = document.getElementById('resultsSection');
            const searchBtn = document.getElementById('searchBtn');

            loadingSection.style.display = 'block';
            resultsSection.classList.remove('visible');
            searchBtn.disabled = true;

            // Search in database
            let foundFormula = null;
            for (const [key, formula] of Object.entries(FORMULA_DATABASE)) {
                if (query.includes(key) || key.includes(query.split(' ').slice(0, 2).join(' '))) {
                    foundFormula = formula;
                    break;
                }
            }

            // If found in database, use it
            if (foundFormula) {
                setTimeout(() => {
                    currentCalculation = foundFormula;
                    currentCalculation.source = "Built-in Database";
                    displayResults(foundFormula);
                    loadingSection.style.display = 'none';
                    searchBtn.disabled = false;
                }, 500);
            } else if (aiConfig.connected) {
                // Use AI if connected
                searchWithAI(query);
            } else {
                // No match and no AI
                loadingSection.style.display = 'none';
                searchBtn.disabled = false;
                resultsSection.innerHTML = `
                    <div class="error-message">
                        <strong>Formula not found in database</strong>
                        <p style="margin-top: 0.5rem;">We don't have a built-in formula for "${query}".</p>
                        <div class="ai-features-locked" style="margin-top: 1rem;">
                            <p>üí° Connect an AI provider to search for any engineering formula!</p>
                            <button class="ai-login-btn" onclick="showAIModal()">Connect AI</button>
                        </div>
                    </div>
                `;
                resultsSection.classList.add('visible');
            }
        }

        async function searchWithAI(query) {
            const loadingSection = document.getElementById('loadingSection');
            const resultsSection = document.getElementById('resultsSection');
            const searchBtn = document.getElementById('searchBtn');

            try {
                const preferredStandard = document.getElementById('preferredStandard').value;
                const specificFormula = document.getElementById('specificFormula').value.trim();

                let promptAdditions = '';
                if (preferredStandard) {
                    promptAdditions += `\nPreferred standard: ${preferredStandard}`;
                }
                if (specificFormula) {
                    promptAdditions += `\nSpecific formula requested: ${specificFormula}`;
                }

                let apiUrl, headers, body;

                if (aiConfig.provider === 'anthropic') {
                    apiUrl = 'https://api.anthropic.com/v1/messages';
                    headers = {
                        'Content-Type': 'application/json',
                        'x-api-key': aiConfig.apiKey,
                        'anthropic-version': '2023-06-01'
                    };
                    body = {
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `You are an engineering expert. The user wants to: "${query}"${promptAdditions}

Please provide:
1. The relevant standard (BS EN, ASME, ISO, or other relevant institute)${preferredStandard ? ` - prefer ${preferredStandard} if applicable` : ''}
2. A brief description of the standard and its application
3. The formula to use${specificFormula ? ` - use ${specificFormula} if applicable` : ''}
4. A list of input variables needed with their symbols, descriptions, and typical units

Format your response as JSON with this structure:
{
  "standard": "standard code/number",
  "standardName": "full name of standard",
  "description": "brief description of what this calculates and the standard",
  "formula": "the mathematical formula using plain text (e.g., Q = A * v)",
  "formulaDescription": "explanation of the formula",
  "variables": [
    {
      "symbol": "Q",
      "name": "Flow Rate",
      "description": "volumetric flow rate",
      "unit": "m¬≥/s",
      "defaultValue": null
    }
  ],
  "resultVariable": {
    "symbol": "Q",
    "name": "Flow Rate",
    "unit": "m¬≥/s"
  }
}

Respond ONLY with valid JSON, no additional text.`
                        }]
                    };
                } else if (aiConfig.provider === 'openai') {
                    apiUrl = 'https://api.openai.com/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${aiConfig.apiKey}`
                    };
                    body = {
                        model: 'gpt-4-turbo-preview',
                        messages: [{
                            role: 'user',
                            content: `You are an engineering expert. Provide a formula for: "${query}"${promptAdditions}. Return ONLY valid JSON with this structure: {"standard":"","standardName":"","description":"","formula":"","formulaDescription":"","variables":[],"resultVariable":{}}`
                        }],
                        response_format: { type: "json_object" }
                    };
                } else if (aiConfig.provider === 'groq') {
                    apiUrl = 'https://api.groq.com/openai/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${aiConfig.apiKey}`
                    };
                    body = {
                        model: 'llama-3.1-70b-versatile',
                        messages: [{
                            role: 'user',
                            content: `You are an engineering expert. Provide a formula for: "${query}"${promptAdditions}. Return ONLY valid JSON with this structure: {"standard":"","standardName":"","description":"","formula":"","formulaDescription":"","variables":[],"resultVariable":{}}`
                        }],
                        response_format: { type: "json_object" }
                    };
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                let responseText;
                if (aiConfig.provider === 'anthropic') {
                    responseText = data.content[0].text;
                } else {
                    responseText = data.choices[0].message.content;
                }

                const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('No JSON found in response');
                }

                const calculationData = JSON.parse(jsonMatch[0]);
                currentCalculation = calculationData;
                currentCalculation.source = `AI (${aiConfig.provider})`;
                displayResults(calculationData);

            } catch (error) {
                resultsSection.innerHTML = `
                    <div class="error-message">
                        <strong>Error:</strong> ${error.message}
                        <br><br>
                        Please check your API key or try again.
                    </div>
                `;
                resultsSection.classList.add('visible');
            } finally {
                loadingSection.style.display = 'none';
                searchBtn.disabled = false;
            }
        }

        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            
            const inputFields = data.variables.map((variable, index) => `
                <div class="input-field">
                    <label class="input-label">${variable.name} (${variable.symbol})</label>
                    <div class="input-with-unit">
                        <input 
                            type="number" 
                            id="input_${index}" 
                            placeholder="Enter ${variable.name.toLowerCase()}"
                            step="any"
                            value="${variable.defaultValue || ''}"
                        >
                        <span class="unit-label">${variable.unit}</span>
                    </div>
                    <small style="color: #64748b; margin-top: 0.25rem; display: block;">${variable.description}</small>
                </div>
            `).join('');

            const variablesList = data.variables.map(v => 
                `<div class="variable-item"><strong>${v.symbol}</strong> = ${v.name} (${v.unit})</div>`
            ).join('');

            const aiLockedMsg = !aiConfig.connected ? `
                <div class="ai-features-locked">
                    <p>üîí AI-powered features require an AI connection</p>
                    <button class="ai-login-btn" onclick="showAIModal()">Connect AI</button>
                </div>
            ` : '';

            resultsSection.innerHTML = `
                <div class="standard-info">
                    <div class="standard-header">
                        <div class="standard-title">üìã ${data.standard} - ${data.standardName}</div>
                        <div class="copy-btns">
                            <button class="copy-btn" onclick="copyReference()">
                                üìã Copy Reference
                            </button>
                            <button class="copy-btn" onclick="copyFormula()">
                                üìê Copy Formula
                            </button>
                        </div>
                    </div>
                    <div class="standard-description">${data.description}</div>
                    
                    <div style="margin-top: 1rem;">
                        <strong style="color: #1e293b;">Formula:</strong>
                        <div class="formula-box" id="formulaText">${data.formula}</div>
                        <p style="color: #64748b; margin-top: 0.5rem; font-size: 0.9rem;">${data.formulaDescription}</p>
                    </div>

                    <div class="variables-list">
                        <strong style="color: #1e293b; display: block; margin-bottom: 0.5rem;">Variables:</strong>
                        ${variablesList}
                    </div>

                    <button class="derivation-btn ${!aiConfig.connected ? 'locked' : ''}" onclick="${aiConfig.connected ? 'showDerivation()' : 'showToast(\'Connect AI to use this feature\', false)'}">
                        üìö Show Derivation from First Principles ${!aiConfig.connected ? 'üîí' : ''}
                    </button>
                    <div id="derivationDisplay"></div>
                    ${aiLockedMsg}
                </div>

                <div class="calculator-section">
                    <div class="calc-header">üßÆ Calculator</div>
                    ${inputFields}
                    <button class="calculate-btn" onclick="performCalculation()">Calculate</button>
                    <div id="resultDisplay"></div>
                </div>

                <div class="metadata-section">
                    <div class="metadata-row">
                        <span class="metadata-label">Source:</span>
                        <span>${data.source || 'Built-in Database'}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Generated:</span>
                        <span>${new Date().toLocaleString()}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Standard:</span>
                        <span>${data.standard}</span>
                    </div>
                </div>
            `;

            resultsSection.classList.add('visible');
        }

        async function showDerivation() {
            if (!aiConfig.connected) {
                showToast('Connect AI to use this feature', false);
                return;
            }
            
            showToast('AI-powered derivation - Feature coming soon!');
            // Implementation would be similar to searchWithAI
        }

        async function performCalculation() {
            if (!currentCalculation) return;

            const inputs = {};
            let allInputsValid = true;

            currentCalculation.variables.forEach((variable, index) => {
                const inputElement = document.getElementById(`input_${index}`);
                const value = parseFloat(inputElement.value);
                
                if (isNaN(value)) {
                    allInputsValid = false;
                    inputElement.style.borderColor = '#dc2626';
                } else {
                    inputElement.style.borderColor = '#e2e8f0';
                    inputs[variable.symbol] = value;
                }
            });

            if (!allInputsValid) {
                document.getElementById('resultDisplay').innerHTML = `
                    <div class="error-message">Please fill in all input fields with valid numbers.</div>
                `;
                return;
            }

            // Simple formula evaluation (for basic formulas)
            try {
                let result;
                const formula = currentCalculation.formula;
                
                // Basic formula evaluation
                if (formula.includes('Q = A √ó v') || formula.includes('Q = A * v')) {
                    result = inputs.A * inputs.v;
                } else if (formula.includes('Re =')) {
                    result = (inputs.œÅ * inputs.v * inputs.D) / inputs.Œº;
                } else if (formula.includes('ŒîP =')) {
                    result = inputs.f * (inputs.L / inputs.D) * (inputs.œÅ * Math.pow(inputs.v, 2) / 2);
                } else if (formula.includes('Q = (k √ó A √ó ŒîT) / L')) {
                    result = (inputs.k * inputs.A * inputs.ŒîT) / inputs.L;
                } else if (formula.includes('Œ¥ =')) {
                    result = (5 * inputs.w * Math.pow(inputs.L, 4)) / (384 * inputs.E * inputs.I);
                } else if (aiConfig.connected) {
                    // Use AI for complex calculations
                    showToast('Using AI for calculation...');
                    // Would implement AI calculation here
                    result = 0;
                } else {
                    throw new Error('Complex formula requires AI connection');
                }

                document.getElementById('resultDisplay').innerHTML = `
                    <div class="result-box">
                        <div class="result-label">${currentCalculation.resultVariable.name}</div>
                        <div class="result-value">${result.toExponential(4)}</div>
                        <div class="result-unit">${currentCalculation.resultVariable.unit}</div>
                    </div>
                `;

            } catch (error) {
                document.getElementById('resultDisplay').innerHTML = `
                    <div class="error-message">
                        <strong>Calculation Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Utility functions
        function useExample(text) {
            document.getElementById('queryInput').value = text;
            searchFormula();
        }

        function toggleAdvanced() {
            const content = document.getElementById('advancedContent');
            const icon = document.getElementById('advancedToggleIcon');
            content.classList.toggle('visible');
            icon.textContent = content.classList.contains('visible') ? '‚ñº' : '‚ñ∂';
        }

        function showToast(message, success = true) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = 'toast show' + (success ? ' success' : '');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function copyReference() {
            if (!currentCalculation) return;
            
            const reference = `${currentCalculation.standard} - ${currentCalculation.standardName}
${currentCalculation.description}

Formula: ${currentCalculation.formula}

Generated: ${new Date().toLocaleString()}
Source: Shan's Engineering Calculator`;
            
            navigator.clipboard.writeText(reference).then(() => {
                showToast('Reference copied to clipboard!');
            }).catch(() => {
                showToast('Failed to copy reference', false);
            });
        }

        function copyFormula() {
            const formulaText = document.getElementById('formulaText');
            if (!formulaText) return;
            
            navigator.clipboard.writeText(formulaText.textContent).then(() => {
                showToast('Formula copied to clipboard!');
            }).catch(() => {
                showToast('Failed to copy formula', false);
            });
        }

        // Allow Enter key to trigger search
        document.getElementById('queryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchFormula();
            }
        });

        // Initialize
        loadAIConfig();
    </script>
</body>
</html>
